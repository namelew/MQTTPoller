version: '3.9'
services:
  broker:
    container_name: mosquitto_broker
    image: eclipse-mosquitto:latest
    volumes:
     - ./mosquitto.confg:/mosquitto/config/mosquitto.conf
     - mosquitto_data:/mosquitto
    networks:
     - example_experiment_network
  orquestrator:
    container_name: orquestrator
    build:
      context: ./images/orquestrator
      cache_from:
        - golang:1.18-alpine
        - alpine:3.17
    image: mqttdb/orquestrator:latest
    deploy:
      resources:
        limits:
          #cpus: '0.40'
          memory: 30M
        reservations:
          #cpus: '0.30'
          memory: 10M
    ports:
      - 8000:8000
    networks:
     - example_experiment_network
    environment:
      - tolerance=5
      - broker=tcp://mosquitto_broker:1883
    depends_on:
      - broker
  workers:
    container_name: worker
    build:
      context: ./images/worker
      cache_from:
        - golang:1.17.13-alpine
        - alpine:3.17
    image: mqttdb/worker:latest
    deploy:
      resources:
        limits:
          cpus: '0.30'
          memory: 30M
        reservations:
          cpus: '0.20'
          memory: 10M
    networks:
     - example_experiment_network
    environment:
      - broker=tcp://mosquitto_broker:1883
      - login_t=30
      - timeout=5
      - tool=source/tools/mqttloader/bin/mqttloader
    depends_on:
      - orquestrator
  workers-2:
    container_name: worker-2
    build:
      context: ./images/worker
      cache_from:
        - golang:1.17.13-alpine
        - alpine:3.17
    image: mqttdb/worker:latest
    deploy:
      resources:
        limits:
          cpus: '0.30'
          memory: 30M
        reservations:
          cpus: '0.20'
          memory: 10M
    networks:
     - example_experiment_network
    environment:
      - broker=tcp://mosquitto_broker:1883
      - login_t=30
      - timeout=5
      - tool=source/tools/mqttloader/bin/mqttloader
    depends_on:
      - orquestrator
  workers-3:
    container_name: worker-3
    build:
      context: ./images/worker
      cache_from:
        - golang:1.17.13-alpine
        - alpine:3.17
    image: mqttdb/worker:latest
    deploy:
      resources:
        limits:
          cpus: '0.30'
          memory: 30M
        reservations:
          cpus: '0.20'
          memory: 10M
    networks:
     - example_experiment_network
    environment:
      - broker=tcp://mosquitto_broker:1883
      - login_t=30
      - timeout=5
      - tool=source/tools/mqttloader/bin/mqttloader
    depends_on:
      - orquestrator
networks:
  example_experiment_network:
    driver: bridge
volumes:
  mosquitto_data:
